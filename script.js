const presets = [
    {
        fileName: "BM3-CHROMED>FACTORY>Grumble Face.mp3",
        cyaniteTags: {
            advancedInstrument: ["Bass Guitar", "Percussion", "Synthesizer", "Electronic Drums", "Drum Kit"],
            genre: ["Electronic Dance"],
            subgenre: ["Abstract IDM Leftfield"],
            advancedMood: ["Energetic", "Weird", "Determined"], // Renamed from mood
            character: ["Powerful", "Unpolished"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "BM3-GLOOM>FACTORY>Urban Exploration.mp3",
        cyaniteTags: {
            advancedInstrument: ["Bass Guitar", "Synthesizer", "Electronic Drums", "Drum Kit"],
            genre: ["Ambient", "Electronic Dance"],
            subgenre: ["Breakbeat/Drum&Bass"],
            advancedMood: ["Mysterious", "Weird",], // Renamed from mood
            character: ["Ethereal", "Mysterious", "Sparse"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "BM3-GLORY>FACTORY>Walk It.mp3",
        cyaniteTags: {
            advancedInstrument: ["Bass Guitar", "Synthesizer", "Electronic Drums", "Drum Kit"],
            genre: ["Rap/Hip-Hop"],
            subgenre: ["Trap"],
            advancedMood: ["Confident", "Cool", "Serious"], // Renamed from mood
            character: ["Cool"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "SE-BRAAASS_EDM Add Some DRUMS.mp3",
        cyaniteTags: {
            advancedInstrument: ["Percussion", "Synthesizer", "Drum Kit", "Bass"],
            genre: ["Electronic Dance"],
            subgenre: ["Electro"],
            advancedMood: ["Serious"], // Renamed from mood
            character: ["Unpolished"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "SE-BRAAASS_EDM Brass Dancehall.mp3",
        cyaniteTags: {
            advancedInstrument: ["Synthesizer", "Bass"],
            genre: ["Electronic Dance", "Ambient"],
            subgenre: ["House"],
            advancedMood: ["Mysterious", "Nervous", "Determined"], // Renamed from mood
            character: ["Ethereal"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "SE-STRIIIINGS_ARP Criss Cross.mp3",
        cyaniteTags: {
            advancedInstrument: ["Bass Guitar", "Strings", "Woodwinds", "Cello", "Double Bass"],
            genre: ["Ambient"],
            subgenre: ["N/A"],
            advancedMood: ["Noble", "Graceful", "Dignified"], // Renamed from mood
            character: ["Sophisticated"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "SE-STRIIIINGS_BRM Earthquake Braaam.mp3",
        cyaniteTags: {
            advancedInstrument: ["Synthesizer"],
            genre: ["Ambient"],
            subgenre: ["N/A"],
            advancedMood: ["Dark", "Eerie", "Tense"], // Renamed from mood
            character: ["Mysterious", "Ethereal", "Unpolished"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "SE-STRIIIINGS_HYB Are you talking to me.mp3",
        cyaniteTags: {
            advancedInstrument: ["Strings", "Synthesizer"],
            genre: ["Singer/Songwriters"],
            subgenre: ["N/A"],
            advancedMood: ["Dark", "Ominous"], // Renamed from mood
            character: ["Mysterious", "Unpolished", "Epic"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "SE-STRIIIINGS_HYB Crisp Pizz Riff.mp3",
        cyaniteTags: {
            advancedInstrument: ["Synthesizer", "Electronic Drums", "Percussion"],
            genre: ["Ambient", "Singer/Songwriters", "Electronic Dance"],
            subgenre: ["N/A"],
            advancedMood: ["Mysterious", "Serious", "Cool"], // Renamed from mood
            character: ["Cool", "Unpolished"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "USYNTH-GLAM_Add Some Space.mp3",
        cyaniteTags: {
            advancedInstrument: ["Synthesizer"],
            genre: ["Ambient"],
            subgenre: ["N/A"],
            advancedMood: ["Mysterious", "Weird", "Cold"], // Renamed from mood
            character: ["Ethereal", "Sparse"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "VB-ROYAL_Beach Toys.mp3",
        cyaniteTags: {
            advancedInstrument: ["Bass Guitar", "Percussion", "Synthesizer", "Electric Piano", "Electronic Drums"],
            genre: ["Pop", "Rock", "Ambient"],
            subgenre: ["Indie/Alternative"],
            advancedMood: ["Confident", "Relaxed"], // Renamed from mood
            character: ["Cool"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "VB-SLAP_Ambient Something.mp3",
        cyaniteTags: {
            advancedInstrument: ["Bass Guitar", "Synthesizer", "Drum Kit"],
            genre: ["Ambient"],
            subgenre: ["N/A"],
            advancedMood: ["Mysterious", "Spooky", "Weird"], // Renamed from mood
            character: ["Mysterious"],
            meter: ["3/4"]
        }
    },
    {
        fileName: "VB-SLAP_Bite Back.mp3",
        cyaniteTags: {
            advancedInstrument: ["Bass Guitar", "Electric Guitar", "Percussion", "Synthesizer", "Bass"],
            genre: ["Electronic Dance"],
            subgenre: ["Minimal", "Techno", "Electro"],
            advancedMood: ["Resolute", "Determined", "Confident"], // Renamed from mood
            character: ["Bold", "Unpolished"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "VD-SOLID_Very Close.mp3",
        cyaniteTags: {
            advancedInstrument: ["Drum Kit", "African Percussion", "Percussion"],
            genre: ["RnB", "Electronic Dance"],
            subgenre: ["Minimal"],
            advancedMood: ["Quirky", "Bright", "Playful"], // Renamed from mood
            character: ["Cool"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "VG-AMBER2_Accordion Jive.mp3",
        cyaniteTags: {
            advancedInstrument: ["Accordion", "Acoustic Guitar", "Bass Guitar", "Strings", "Drum Kit"],
            genre: ["Ambient", "Pop"],
            subgenre: ["N/A"],
            advancedMood: ["Thoughtful", "Reflective", "Serious"], // Renamed from mood
            character: ["Warm"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "VG-AMBER2_You Want This.mp3",
        cyaniteTags: {
            advancedInstrument: ["Acoustic Guitar"],
            genre: ["Pop"],
            subgenre: ["N/A"],
            advancedMood: ["Bright", "Warm", "Reflective"], // Renamed from mood
            character: ["Warm"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "VG-IRON2_Little Brothers Amp.mp3",
        cyaniteTags: {
            advancedInstrument: ["Synthesizer", "Electric Guitar"],
            genre: ["Ambient"],
            subgenre: ["N/A"],
            advancedMood: ["Dark", "Ominous", "Weird"], // Renamed from mood
            character: ["Unpolished"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "VG-IRON2_Sixtyone Alien Ships.mp3",
        cyaniteTags: {
            advancedInstrument: ["Drum Kit", "Synthesizer"],
            genre: ["Electronic Dance", "Ambient"],
            subgenre: ["Abstract IDM Leftfield", "Techno", "Minimal"],
            advancedMood: ["Dark", "Violent", "Disturbing"], // Renamed from mood
            character: ["Unpolished"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "VG-SPARKLE2_Bidobido.mp3",
        cyaniteTags: {
            advancedInstrument: ["Synthesizer"],
            genre: ["Ambient", "Electronic Dance"],
            subgenre: ["N/A"],
            advancedMood: ["Tense", "Mysterious", "Suspenseful"], // Renamed from mood
            character: ["Unpolished", "Mysterious", "Sparse"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "VP-SCORE_61 bpm - Fate.mp3",
        cyaniteTags: {
            advancedInstrument: ["Piano"],
            genre: ["Ambient"],
            subgenre: ["N/A"],
            advancedMood: ["Sad", "Melancholic", "Poignant"], // Renamed from mood
            character: ["Sophisticated", "Warm"],
            meter: ["3/4"]
        }
    },
    {
        fileName: "VP-VIBE_72 bpm - Cuddle Me Now.mp3",
        cyaniteTags: {
            advancedInstrument: ["Bass Guitar", "Piano", "Synthesizer", "Vibraphone", "Electric Piano"],
            genre: ["Jazz"],
            subgenre: ["Smooth Jazz"],
            advancedMood: ["Dreamy", "Quiet", "Relaxed"], // Renamed from mood
            character: ["Retro", "Warm", "Sophisticated"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "VP-VOGUE_Finisher Equals Fun.mp3",
        cyaniteTags: {
            advancedInstrument: ["Piano", "Synthesizer"],
            genre: ["Ambient"],
            subgenre: ["N/A"],
            advancedMood: ["Mysterious", "Cold", "Lonely"], // Renamed from mood
            character: ["Ethereal", "Sparse", "Mysterious"],
            meter: ["4/4"]
        }
    },
    {
        fileName: "VP-VOGUE_Reverse Hookliner.mp3",
        cyaniteTags: {
            advancedInstrument: ["Piano", "Synthesizer"],
            genre: ["Ambient"],
            subgenre: ["N/A"],
            advancedMood: ["Lonely", "Bittersweet", "Thoughtful"], // Renamed from mood
            character: ["Ethereal", "Sparse", "Mysterious"],
            meter: ["4/4"]
        }
    }
];

let currentPresetIndex = 0;
let currentCategoryIndex = 0;
let userResponses = {}; // Store all user responses
let presetOrder = []; // Randomized order of presets

// LocalStorage keys
const STORAGE_KEYS = {
    RESPONSES: 'metadata-survey-responses',
    PRESET_INDEX: 'metadata-survey-preset-index',
    CATEGORY_INDEX: 'metadata-survey-category-index',
    PRESET_ORDER: 'metadata-survey-preset-order'
};

const categories = [
    {
        key: 'advancedInstrument',
        label: 'Instrument',
        headerText: 'Please vote on how well you agree with the identified <strong>Instrument(s)</strong> of this sound.',
        questionText: 'Ask yourself: <em>"If I were looking for [INSTRUMENT] sounds, would I be satisfied with this result?"</em>'
    },
    {
        key: 'genre',
        label: 'Genre',
        headerText: 'Please vote on how well you agree with the identified <strong>Genre(s)</strong> of this sound.',
        questionText: 'Ask yourself: <em>"If I were looking for [GENRE] sounds, would I be satisfied with this result?"</em>'
    },
    {
        key: 'subgenre',
        label: 'Subgenre',
        headerText: 'Please vote on how well you agree with the identified <strong>Subgenre(s)</strong> of this sound.',
        questionText: 'Ask yourself: <em>"If I were looking for [SUBGENRE] sounds, would I be satisfied with this result?"</em>'
    },
    {
        key: 'advancedMood',
        label: 'Mood',
        headerText: 'Please vote on how well you agree with the identified <strong>Mood</strong> of this sound.',
        questionText: 'Ask yourself: <em>"If I were looking for [MOOD] sounds, would I be satisfied with this result?"</em>'
    },
    {
        key: 'character',
        label: 'Character',
        headerText: 'Please vote on how well you agree with the identified <strong>Character</strong> of this sound.',
        questionText: 'Ask yourself: <em>"If I were looking for [CHARACTER] sounds, would I be satisfied with this result?"</em>'
    }
];

function createVotingScale(category, tag) {
    const groupName = `${category}-${tag.replace(/\s+/g, '-')}`;
    return `
        <div class="voting-scale">
            <em>Disagree</em>
            <input type="radio" name="${groupName}" value="1">
            <input type="radio" name="${groupName}" value="2">
            <input type="radio" name="${groupName}" value="3">
            <input type="radio" name="${groupName}" value="4">
            <input type="radio" name="${groupName}" value="5">
            <em>Agree</em>
        </div>
    `;
}

function loadPreset(index) {
    const actualPresetIndex = presetOrder[index];
    const preset = presets[actualPresetIndex];
    const title = document.getElementById('preset-title');
    const audioPlayer = document.getElementById('audio-player');
    const audioSource = document.getElementById('audio-source');

    title.textContent = `Preset ${index + 1} of ${presets.length}`;
    audioSource.src = `audio/${preset.fileName}`;
    audioPlayer.load();

    currentCategoryIndex = 0;
    loadCategory();
}

function saveCurrentResponses() {
    const actualPresetIndex = presetOrder[currentPresetIndex];
    const preset = presets[actualPresetIndex];
    const category = categories[currentCategoryIndex];
    const tags = preset.cyaniteTags[category.key].filter(tag => tag !== "N/A" && tag !== "");

    tags.forEach(tag => {
        const groupName = `${category.key}-${tag.replace(/\s+/g, '-')}`;
        const selectedRadio = document.querySelector(`input[name="${groupName}"]:checked`);
        if (selectedRadio) {
            const key = `preset${currentPresetIndex}-${groupName}`;
            userResponses[key] = selectedRadio.value;
        }
    });

    // Save to localStorage
    saveToLocalStorage();
}

function saveToLocalStorage() {
    localStorage.setItem(STORAGE_KEYS.RESPONSES, JSON.stringify(userResponses));
    localStorage.setItem(STORAGE_KEYS.PRESET_INDEX, currentPresetIndex.toString());
    localStorage.setItem(STORAGE_KEYS.CATEGORY_INDEX, currentCategoryIndex.toString());
    localStorage.setItem(STORAGE_KEYS.PRESET_ORDER, JSON.stringify(presetOrder));
}

function loadFromLocalStorage() {
    const savedResponses = localStorage.getItem(STORAGE_KEYS.RESPONSES);
    const savedPresetIndex = localStorage.getItem(STORAGE_KEYS.PRESET_INDEX);
    const savedCategoryIndex = localStorage.getItem(STORAGE_KEYS.CATEGORY_INDEX);
    const savedPresetOrder = localStorage.getItem(STORAGE_KEYS.PRESET_ORDER);

    if (savedResponses) {
        userResponses = JSON.parse(savedResponses);
    }
    if (savedPresetIndex !== null) {
        currentPresetIndex = parseInt(savedPresetIndex);
    }
    if (savedCategoryIndex !== null) {
        currentCategoryIndex = parseInt(savedCategoryIndex);
    }
    if (savedPresetOrder) {
        presetOrder = JSON.parse(savedPresetOrder);
    }

    return savedResponses !== null;
}

function clearLocalStorage() {
    localStorage.removeItem(STORAGE_KEYS.RESPONSES);
    localStorage.removeItem(STORAGE_KEYS.PRESET_INDEX);
    localStorage.removeItem(STORAGE_KEYS.CATEGORY_INDEX);
    localStorage.removeItem(STORAGE_KEYS.PRESET_ORDER);
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

function initializePresetOrder() {
    if (presetOrder.length === 0) {
        // Create randomized order: array of indices [0, 1, 2, ..., 22]
        presetOrder = shuffleArray([...Array(presets.length).keys()]);
        saveToLocalStorage();
    }
}

function loadCategory() {
    const actualPresetIndex = presetOrder[currentPresetIndex];
    const preset = presets[actualPresetIndex];
    const questionsContainer = document.getElementById('questions-container');
    const categoryHeader = document.getElementById('category-header');
    const categoryQuestion = document.getElementById('category-question');
    const category = categories[currentCategoryIndex];
    const backBtn = document.getElementById('back-btn');

    questionsContainer.innerHTML = '';

    // Update dynamic header and question
    categoryHeader.innerHTML = category.headerText;
    categoryQuestion.innerHTML = category.questionText;

    const tags = preset.cyaniteTags[category.key];

    // Filter out N/A tags and empty strings
    const validTags = tags.filter(tag => tag !== "N/A" && tag !== "");

    if (validTags.length === 0) {
        // Skip to next category if no valid tags
        nextCategory();
        return;
    }

    validTags.forEach(tag => {
        questionsContainer.innerHTML += `
            <div class="question">
                <p>${category.label}: <strong>${tag}</strong></p>
                ${createVotingScale(category.key, tag)}
            </div>
        `;
    });

    // Restore previously saved responses
    validTags.forEach(tag => {
        const groupName = `${category.key}-${tag.replace(/\s+/g, '-')}`;
        const key = `preset${currentPresetIndex}-${groupName}`;
        if (userResponses[key]) {
            const radio = document.querySelector(`input[name="${groupName}"][value="${userResponses[key]}"]`);
            if (radio) {
                radio.checked = true;
            }
        }
    });

    // Always show back button
    backBtn.style.display = 'inline-block';
}

function nextCategory() {
    saveCurrentResponses();
    currentCategoryIndex++;

    if (currentCategoryIndex < categories.length) {
        loadCategory();
    } else {
        // Move to next preset
        currentPresetIndex++;
        if (currentPresetIndex < presets.length) {
            loadPreset(currentPresetIndex);
        } else {
            // Survey complete
            showCompleteScreen();
        }
    }
}

function showCompleteScreen() {
    const testContainer = document.getElementById('test-container');
    const completeContainer = document.getElementById('complete-container');

    testContainer.style.display = 'none';
    completeContainer.style.display = 'block';
}

function downloadResults() {
    // Structure the data for export
    const exportData = {
        timestamp: new Date().toISOString(),
        responses: []
    };

    // Iterate through the order the user saw them (0-22)
    for (let displayIndex = 0; displayIndex < presets.length; displayIndex++) {
        const actualPresetIndex = presetOrder[displayIndex];
        const preset = presets[actualPresetIndex];

        const presetData = {
            presetIndex: actualPresetIndex,
            presetName: preset.fileName,
            displayOrder: displayIndex + 1,
            votes: {}
        };

        // Collect all votes for this preset
        Object.keys(userResponses).forEach(key => {
            if (key.startsWith(`preset${displayIndex}-`)) {
                const voteKey = key.replace(`preset${displayIndex}-`, '');
                presetData.votes[voteKey] = parseInt(userResponses[key]);
            }
        });

        exportData.responses.push(presetData);
    }

    // Create download
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);

    const link = document.createElement('a');
    link.href = url;
    link.download = `metadata-survey-${Date.now()}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    // Clear localStorage after successful download
    clearLocalStorage();
}

function previousCategory() {
    saveCurrentResponses();
    currentCategoryIndex--;

    if (currentCategoryIndex < 0) {
        // Go to previous preset or welcome screen
        currentPresetIndex--;
        if (currentPresetIndex < 0) {
            // Return to welcome screen
            showWelcomeScreen();
        } else {
            currentCategoryIndex = categories.length - 1;
            loadPreset(currentPresetIndex);
        }
    } else {
        loadCategory();
    }
}

function showWelcomeScreen() {
    const welcomeContainer = document.getElementById('welcome-container');
    const testContainer = document.getElementById('test-container');

    welcomeContainer.style.display = 'block';
    testContainer.style.display = 'none';
    currentPresetIndex = 0;
    currentCategoryIndex = 0;
}

// --- NEW: Main script execution ---
// This code runs after the page has loaded.
document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('start-btn');
    const resumeBtn = document.getElementById('resume-btn');
    const startFreshBtn = document.getElementById('start-fresh-btn');
    const nextBtn = document.getElementById('next-btn');
    const backBtn = document.getElementById('back-btn');
    const downloadBtn = document.getElementById('download-btn');
    const welcomeContainer = document.getElementById('welcome-container');
    const testContainer = document.getElementById('test-container');
    const resumeSection = document.getElementById('resume-section');

    // Check for saved progress on page load
    const hasSavedProgress = loadFromLocalStorage();

    if (hasSavedProgress) {
        // Show resume options
        resumeSection.style.display = 'block';
        startBtn.style.display = 'none';
    }

    // Add a click listener to the 'Continue' button (new survey)
    startBtn.addEventListener('click', function() {
        startSurvey();
    });

    // Add a click listener to the 'Resume' button
    resumeBtn.addEventListener('click', function() {
        // Hide the welcome screen
        welcomeContainer.style.display = 'none';
        // Show the test screen
        testContainer.style.display = 'block';
        // Load the exact preset and category where they left off
        const actualPresetIndex = presetOrder[currentPresetIndex];
        const preset = presets[actualPresetIndex];
        const title = document.getElementById('preset-title');
        const audioPlayer = document.getElementById('audio-player');
        const audioSource = document.getElementById('audio-source');

        title.textContent = `Preset ${currentPresetIndex + 1} of ${presets.length}`;
        audioSource.src = `audio/${preset.fileName}`;
        audioPlayer.load();

        loadCategory();
    });

    // Add a click listener to the 'Start Fresh' button
    startFreshBtn.addEventListener('click', function() {
        clearLocalStorage();
        currentPresetIndex = 0;
        currentCategoryIndex = 0;
        userResponses = {};
        startSurvey();
    });

    function startSurvey() {
        // Initialize randomized preset order if starting fresh
        initializePresetOrder();
        // Hide the welcome screen
        welcomeContainer.style.display = 'none';
        // Show the test screen
        testContainer.style.display = 'block';
        // Load the first preset
        loadPreset(currentPresetIndex);
    }

    // Add a click listener to the 'Next' button
    nextBtn.addEventListener('click', function() {
        nextCategory();
    });

    // Add a click listener to the 'Back' button
    backBtn.addEventListener('click', function() {
        previousCategory();
    });

    // Add a click listener to the 'Download Results' button
    downloadBtn.addEventListener('click', function() {
        downloadResults();
    });
});